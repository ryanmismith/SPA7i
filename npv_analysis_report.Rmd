---
title: "NPV Analysis Report"
output:
  html_document:
    toc: true
    toc_depth: 3
    theme: journal
date: "`r Sys.Date()`"
---

```{=html}
<style>
/* Add a full black border around the entire table */
table {
  border-collapse: collapse;
  width: 80%;  /* Adjust the width to allow for larger margins */
  margin: 30px auto;
  border: 1px solid black;  /* Full border around the table */
}


/* Ensure both table headers and cells have borders */
table th, table td {
  border: 1px solid black;  /* Full border around each cell */
  padding: 10px;
  text-align: center;
  color: black;
}

/* Optional: Style the table header */
table th {
  background-color: #f2f2f2;
  font-weight: bold;
}

 /* Add space between headers and figures */
  h3 {
    margin-bottom: 20px;
  }

  /* Add space between figures (images) */
  img {
  padding-bottom: 20px;
}
.centered-plot {
  margin-bottom: 20px;
  text-align: center;
}

</style>
```

```{r setup, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(purrr)
library(SPA7i)
library(ggplot2)
library(knitr)
library(kableExtra)

# Load and clean the data
vols <- dataPreparation("~/Projects/SPA/Arc Outputs/SPA_test3.csv")


# Create Necessary Dataframes

ratios <- calculateProductRatios(vols)
peracre <- GrowthModelInput(vols)
results_combined <- run_aac_for_all(peracre, .5, 10, TRUE, TRUE, 30)
product_volumes <- calculateProductVolumes(results_combined, ratios)

# 
# Filtering and calculating product values
product_values <- c("ASl" = 120, "ASp" = 115, "BFl" = 185, "BFp" = 20, "CEl" = 215,
                    "CEp" = 0, "HVl" = 300, "HVp" = 25, "HVt" = 135, "LVl" = 140,
                    "LVp" = 25, "LVt" = 95, "OSl" = 75, "OSp" = 20, "SPl" = 165,
                    "SPp" = 20, "WPl" = 150, "WPp" = 10)

product_values_df <- data.frame(product = names(product_values), product_value = as.numeric(product_values))

product_volumes <- product_volumes %>%
  left_join(product_values_df, by = "product") %>%
  mutate(
    harvest_value = product_harvest_volume * product_value,
    standing_value = product_standing_volume * product_value
  )

product_volumes <- product_volumes |> filter(is.na(harvest_value) == FALSE)

# Calculate NPV values
NPVvalues <- product_volumes %>%
  group_by(year) %>%
  summarise(harvest_value = sum(harvest_value), standing_value = sum(standing_value))


max_year <- max(NPVvalues$year)
final_standing_value <- NPVvalues %>% filter(year == max_year) %>% pull(standing_value)

# Creating the final flow dataframe
flow_df <- NPVvalues %>%
  select(year, harvest_value)

# Monte Carlo Analysis
npv <- monteCarloAnalysis(Flow = flow_df$harvest_value, Occurrence = flow_df$year,
                          NominalRate = .05, TerminalYear = 20, FutureValue = final_standing_value,
                          Exit = FALSE)# Filtering and calculating product values
ci_data <- ci_table(npv$NPVs)

# Extract the mean NPV value
mean_npv <- mean(npv$NPVs)

# Extract the 80% CI values from ci_data
lower_bound_80 <- ci_data[ci_data$CI == '80%', 'Lower_Bound']
upper_bound_80 <- ci_data[ci_data$CI == '80%', 'Upper_Bound']
spread <- upper_bound_80 - lower_bound_80

total_acres <- vols |> group_by(township, matrix) |> slice(1) |> summarise(acres = sum(acres)) |> ungroup() |> summarise(round(sum(acres),1))
township_acres <- vols |> 
  rename(Township = "township") |> 
  group_by(Township) |> slice(1) |> 
  summarise(Acres = round(sum(acres),1))
matrix_acres <- vols |> 
  rename(Matrix = "matrix") |> 
  group_by(Matrix) |> slice(1) |> 
  summarise(Acres = round(sum(acres),1))

# Stocking
stockingsummary <- summarizeProductVolumes(results_combined, ratios)
total_initial_cords <- sum(stockingsummary$summary_volumes$initial_volume)
total_final_cords <- sum(stockingsummary$summary_volumes$final_volume)
```

\pagebreak

# Net Present Value (NPV)

The mean NPV value is **$`r format(mean_npv, big.mark = ",", digits = 2)`** and the 80% confidence intervals have a lower bound of **$`r format(lower_bound_80, big.mark = ",", digits = 2)`** and an upper bound of **$`r format(upper_bound_80, big.mark = ",", digits = 2)`**. The spread between the upper and lower bounds is **$`r format(spread, big.mark = ",", digits = 2)`**.

## NPV Monte Carlo Distribution

::: {style="text-align: center;"}
```{r npv-distribution-plot, echo=FALSE, fig.width=7, fig.height=5.5, out.extra='style="border:none;"'}
plotNPVDistribution(npv, "T9R11 Parcel", FALSE, TRUE)
```
:::

\n

## Confidence Intervals for NPV

::: {style="text-align: center;"}
```{r ci-table, warning=FALSE, message=FALSE, echo=FALSE}
# Call the `ci_table` function to generate the confidence interval data
ci_data <- ci_table(npv$NPVs)

# Rename and format the columns with dollar signs and commas
ci_data <- ci_data %>%
  rename("Lower Bound" = "Lower_Bound", "Upper Bound" = "Upper_Bound") %>% 
  mutate(
    `Lower Bound` = paste0("$", format(`Lower Bound`, big.mark = ",", scientific = FALSE)),
    Mean = paste0("$", format(mean_npv, big.mark = ",", scientific = FALSE)),
    `Upper Bound` = paste0("$", format(`Upper Bound`, big.mark = ",", scientific = FALSE))
  ) %>%
  select(CI, `Lower Bound`, Mean, `Upper Bound`)  # Reorder columns here

# Use knitr's kable function to display the table with formatted column headers
ci_data %>%
  kable(col.names = c("CI", "Lower Bound", "Mean", "Upper Bound"),
        caption = "Upper Bound, Mean, and Lower Bound for Key Confidence Intervals",
        escape = FALSE, align = "c") %>%
  kable_styling(full_width = FALSE, position = "center", bootstrap_options = c("striped", "condensed")) %>%
  column_spec(1, width = "3.5cm") %>%
  column_spec(2, width = "3.5cm") %>%
  column_spec(3, width = "3.5cm") %>%
  column_spec(4, width = "3.5cm")
```
:::

\n

# Financials

## Initial Standing Value

**This is a placeholder.** 

## Standing Value Across Time

**This is a placeholder.** 

## Final Standing Value

**This is a placeholder. Populating this section is not possible without building the application.**

## Data populated by the user

-   ***This is where user information entered re: revenues and expenses will be entered.***

-   One time and annual expenses (mgmt fees, roads, etc.)

-   One time and annual revenues from HBU or other sources.

## Harvest Revenue Assumptions

\pagebreak

# Area Summary

The total forested area is `r total_acres` acres.

## Forested Acres - Township

::: {style="text-align: center;"}
```{r township_acres-table, warning=FALSE, message=FALSE, echo=FALSE}
knitr::kable(
  township_acres,
  caption = "Forested Acres By Township",
  escape = FALSE, align = "c") %>%
  kable_styling(full_width = FALSE, position = "center", bootstrap_options = c("striped", "condensed")) %>%
  column_spec(1, width = "6cm") %>%
  column_spec(2, width = "6cm") 
```
:::

## Forested Acres - Matrix

::: {style="text-align: center;"}
```{r matrix_acres-table, warning=FALSE, message=FALSE, echo=FALSE}
knitr::kable(
  matrix_acres,
  caption = "Forested Acres By Matrix", escape = FALSE, align = "c"
) %>%
  kable_styling(full_width = FALSE, position = "center", bootstrap_options = c("striped", "condensed")) %>%
  column_spec(1, width = "5cm") %>%
  column_spec(2, width = "5cm") 
```
:::

-   **Other details**
    -   Gross acres vs forested.
    -   Developed acres.
    -   Riparian and Deer Yard acres.
-   ***The specific summaries for the geographic area of interest still need to be defined.***

\pagebreak

# Stocking and AAC Summary

The initial total stocking is **`r format(total_initial_cords, big.mark = ",")`** cords, or **`r round(total_initial_cords/total_acres, 1)`** cords/acre.

\n

The final stocking at **year `r max(stockingsummary$summary_volumes$final_year)`** is **`r format(total_final_cords, big.mark = ",")`** cords, or **`r round(total_final_cords/total_acres, 1)`** cords/acre.

\n

The following table provides a stocking summary at the start of the simulation and the final stocking at the end of the simulation, Year `r max(stockingsummary$summary_volumes$final_year)`.

## Stocking Table

::: {style="text-align: center;"}
```{r stocking-table, warning=FALSE, message=FALSE, echo=FALSE}
# Call the `generate_final_standing_summary` function to generate summary data
stockingtable <- stockingsummary$summary_volumes |> select(species_group, initial_volume, final_volume)

# Dynamically set the column names and pass them directly to kable
knitr::kable(
  stockingtable,
  col.names = c("Species Group", "Year 1 Cords", paste0("Year ", max(stockingsummary$summary_volumes$final_year), " Cords")),
  caption = "Total Stocking Summary",
  escape = FALSE, align = c('l','c','c')
) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "condensed")) %>%
  column_spec(1, width = "4cm") %>%
  column_spec(2, width = "4cm") |> 
  column_spec(3, width = "4cm") %>%
  row_spec(0, bold = TRUE, background = "#f2f2f2")
```
:::

\pagebreak

### Stocking Plots
```{r annual-stocking-plot, warning=FALSE, message=FALSE, echo=FALSE, fig.width=7, fig.height=3, out.extra='style="border:none;"'}
stockingplots <- plotProductVolumes(stockingsummary)
stockingplots$annual_inventory_plot
```

```{r summary-stocking-plot, warning=FALSE, message=FALSE, echo=FALSE, fig.width=7, fig.height=3, out.extra='style="border:none;"'}

stockingplots$stockingplot

```


\pagebreak

### AAC Plots

```{r annual-aac-plot, warning=FALSE, message=FALSE, echo=FALSE, fig.width=7, fig.height=3, out.extra='style="border:none;"'}
stockingplots$annual_aac_plot
```


```{r summary-aac-plot, warning=FALSE, message=FALSE, echo=FALSE, fig.width=7, fig.height=3, out.extra='style="border:none;"'}
stockingplots$aacplot
```

